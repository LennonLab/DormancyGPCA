---
title: "RpfCommunity-AbundanceDiversity"
author: "Venus Kuo"
date: "June 8th, 2017"
output: pdf_document
---

## 1) Questions

We test whether a concentration gradent of Rpf can affect the diversity and abundance of soil microbial community on agar plates.

Soil was extracted from Dunn woods over the course of months, treated to a gradient of Rpf concentrations (umol/L) for 3 days before vortexed in pyrophosphate solution and spread plated on R2A plates infused with cycloheximide. Colony forming units (CFU) and distinct morphological (unique) colony were counted by eye on plate counter. 

## 2) Set working environment and load packages

```{r setup}
# Set working directory #
rm(list = ls())
getwd()
setwd("~/../GitHub/DormancyGPCA/data/")

# Require or install packages #
package.list <- c('vegan', 'ggplot2', 'gplots', 'psych', 'corrplot', 'BiodiversityR', 'RColorBrewer') 
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package)
    library(package, character.only=T)
} }
```

## 3) Load and describe data set

cfu.txt : An text file containing the sample location, treatment concentration, replicate number, dilution factor, colony counts, and morphology counts. 

I calulated CFU based on colony counts and dilution factor. I standardized the CFU and morphotype counts by soil amount (g). CFU was log10 transformed to look at the magnitude of CFU changes with Rpf treatment. The Rpf treatment concentration was natural log transformed due to uneven concentration treatments. 

```{r}
setwd("~/../GitHub/DormancyGPCA/data/")
# Load cfu.csv dataset #
cfu <- read.csv("plateCfuMorphotypeData.txt",  header=T)

# Calculating and standardizing CFU # 
dil.factor <- cfu$Dilution
soilamount <- cfu$Soil
cfu$CFU <- cfu$Colonies/dil.factor
cfu$stdCFU <- (cfu$CFU)/soilamount
cfu$stdcfu.log<- log10(cfu$stdCFU) 

# Standardizing morphotype # 
cfu$stdMorph <- (cfu$Morphotypes/soilamount)
cfu$stdMorph.log <- log(cfu$stdMorph)

# Natural log transform Rpf concentration # 
x <- (cfu$RpfConcentration)
cfu$rpf <- log2(cfu$RpfConcentration + 1)

# Look at the data set # 
View(cfu)
```

## 4) Color code dates of soil samples

See cfu.xlsx or cfu.csv for soil collection dates

```{r}
#Create a custom color scale
myColors <- brewer.pal(3,"Set1")  # 5 is the number of sampling time points #
names(myColors) <- levels(cfu$Sample)
colScale <- scale_colour_manual(name = "Sample",values = myColors)
#One plot with all the data
#p <- ggplot(dat,aes(x,y,colour = grp)) + geom_point() # colour = Sampling Time Points will be in aes below to label levels #
#cfu <- cfu[1:30, ]
```

## 5) Visualization of hump-shaped relationship by scatter plot 

```{r}
# Colony forming units/ soil (g) with increasing Rpf concentration to soil #
cfu.point <- ggplot(cfu, aes(x=rpf, y = stdcfu.log, colour=Sample)) + 
  geom_point() #+   # Scatter plot #
  #colScale  # To add the colors for each time point #
  
cfu.plot <- cfu.point +    # Figure editting #
  labs(x=expression(paste("Rpf concentrations, Log2(",mu,"mol/L)")), 
       y="Log10(CFU)") +
  theme_classic() +
  theme(axis.text.y=element_text(colour="black", size=15, margin =margin(0,15,0,0)),
        axis.text.x=element_text(colour="black", size =20, margin =margin(15,0,0,0)),
        axis.title.y = element_text(colour="black", size=20,  margin = margin(0,25,0,10)),
        axis.title.x = element_text(colour="black", size=20,  margin=margin(25,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(-0.35, "cm"),
        axis.ticks = element_line(size = 1.65, colour="black"),
        legend.title = element_text(size=15),
        legend.text=element_text(size=15)) +
  scale_x_continuous(breaks = round(seq(0, 6, by = 1),1)) #+
 # annotate("text", x =0.2, y=8005000, label = c("A"), size=12)
cfu.plot
```



```{r}
## Ken's code from the Jim Holland program # 
# Linear model #
mod <- lm(stdcfu.log ~ x + I(x^2), data=cfu)
dat2 <- data.frame(cbind('rpf'=cfu$rpf, 'cfu'=predict(mod)))
dat2 <- dat2[order(dat2), ]
dat2 <- dat2[complete.cases(dat2), ]

r2 <- summary(mod)$r.squared
coefs <- summary(mod)$coefficients
summary(mod)

title <- paste("Colonies vs Rpf,\n r-square=", round(r2,2))

# Plot scatterplot 
plot.new()
par(mfrow=c(1, 1), mar = c(5,5,3,1), oma =c(0,0,2,0))

title <- paste("Colonies vs Rpf,\n r-square=", round(r2,2))
plot(cfu$rpf, cfu$cfu.log, main=title, 
  	xlab="Rpf concentration, log2(umol/L)", ylab="CFU",
  	cex.lab=1.5, cex.main=1.5, pch=19)

# predicts + interval
newx <- seq(min(cfu$rpf), max(cfu$rpf), len=68)
preds <- predict(mod, data.frame(rpf = newx), interval = "confidence") 

clr <- 'gray' #c(2,2,3,4,5) 
clr <- adjustcolor(clr, alpha.f = 0.3) 
polygon(c(rev(newx), newx), c(rev(preds[ ,3]), preds[ ,2]), col = clr, border = NA)

lines(dat2$rpf, dat2$cfu, col="red", lwd=2) # regression line (y~x) 
lines(lowess(cfu$rpf, cfu$cfu.log), col="blue", lwd=2) # lowess line (x,y)
points(cfu$rpf, cfu$cfu, pch=19)
dev.off()

```





```{r}
# Unique colony morphology / soil (g) with increasing Rpf concentration to soil #
uniq.point <- ggplot(cfu, aes(x=rpf, y = stdMorph, colour=Sample)) + 
  geom_point()  #+ # Scatter plot #
  #colScale  # To add the colors for each time point #

uniq.plot <- uniq.point +   # Figure Editting # 
  labs(x=expression(paste("Rpf concentrations (",mu,"mol/L)")), 
       y="Unique Morphology / Soil (g)") +
  theme_classic() +
  theme(axis.text.y=element_text(colour="black", size=15, margin =margin(0,15,0,0)),
        axis.text.x=element_text(colour="black", size =20, margin =margin(15,0,0,0)),
        axis.title.y = element_text(colour="black", size=18,  margin = margin(0,25,0,10)),
        axis.title.x = element_text(colour="black", size=20, margin=margin(25,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(-0.35, "cm"),
        axis.ticks = element_line(size = 1.65, colour="black"),
        legend.title = element_text(size=15),
        legend.text=element_text(size=15)) +
  scale_x_continuous(breaks = round(seq(0, 6, by = 1),1)) #+
  #annotate("text", x =0.1, y=30, label = c("B"), size=12)
uniq.plot  # Plot #
```

# Generalized Linear Models # 

```{r}
# Poisson Regression # 
# Used when predicting an outcome variable representing counts from a set of continuous predictor variables #
fit.cfu <- glm(stdCFU~Concentration,data=cfu,family=quasipoisson())
summary(fit.cfu)

fit.uc <- glm(StdUC~Concentration,data=cfu,family=poisson())
summary(fit.uc)
```







